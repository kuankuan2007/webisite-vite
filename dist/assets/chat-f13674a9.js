import{_ as e,a as t,I as a,J as s,a0 as n,o,b as l,d as i,w as u,a1 as r,u as d,e as c,t as h,v as m,F as p,N as v,h as y,q as f,a2 as g,T as x,Y as b,M as k,n as w,r as _,s as S,O as q,a3 as B,j as E,K as C,L as T,p as j,f as L,i as O}from"./all-0629bb55.js";import{m as $}from"./header-1d5f39b0.js";import{_ as M}from"./markdownShower-1ccba682.js";import{m as N}from"./markDownEditor-e52d1822.js";const H={class:"menu"},I={key:0,class:"title"},J={class:"choice-list"},W=["onClick"],D=e({__name:"menu",props:{data:{type:Object,required:!0},x:{type:Number,required:!0},y:{type:Number,required:!0},show:{type:Boolean,required:!0},parentWidth:{type:Number,default:0,required:!1}},emits:["choice"],setup(e,{expose:b,emit:k}){const w=e;let _=t();a((()=>{s((()=>{w.x,w.y,O()}))}));let S=t(0),q=t(0),B=t(0),E=document.querySelector("body>#contextBox");function C(e){k("choice",e)}E||(E=document.createElement("div"),E.id="contextBox",document.body.appendChild(E));let T=0,j=0;function L(e){e.style.height=0}function O(){n.height-w.y<T+10?B.value=n.height-T-10-w.y:B.value=0,n.width-w.x<j+10?q.value=-j-w.parentWidth:q.value=0}function $(e){e.style.height="auto",T=e.clientHeight,j=e.clientWidth,O(),e.style.height="0",requestAnimationFrame((()=>{e.style.height=T+"px"}))}function M(e){e.style.top=w.y+T+"px",e.style.height=0}let N=t(),R=t(),A=t(void 0);return s((()=>{w.show||(A.value=void 0)})),b({menuBox:R}),(t,a)=>(o(),l("div",{class:"menu-box",ref_key:"menuBox",ref:R},[i(x,{duration:300,onBeforeEnter:L,onLeave:M,onEnter:$},{default:u((()=>[e.show?(o(),l("div",{key:0,class:"menu-fixd",ref_key:"menuEle",ref:N,style:r({"--x":d(w).x+d(q)+"px","--y":d(w).y+d(B)+"px"})},[c("div",H,[d(w).data.title?(o(),l("p",I,h(d(w).data.title),1)):m("",!0),c("ul",J,[(o(!0),l(p,null,v(e.data.menu,((e,t)=>(o(),l("li",{class:"choice",onClick:a=>function(e,t,a){e.sub?(A.value=t,S=a.target.offsetTop):e.event&&C(e.event)}(e,t,a),key:t},[y(h(e.title)+" ",1),(o(),f(g,{ref_for:!0,ref_key:"nowSubMenuTP",ref:_,to:d(E)},[e.sub?(o(),f(D,{key:0,ref_for:!0,ref:"nowSubMenu",show:d(A)===t,y:d(w).y+d(B)+d(S),x:d(w).x+d(q)+d(j),onChoice:a[0]||(a[0]=e=>C(e)),data:e.sub,"parent-width":d(j)},null,8,["show","y","x","data","parent-width"])):m("",!0)],8,["to"]))],8,W)))),128))])])],4)):m("",!0)])),_:1})],512))}},[["__scopeId","data-v-a05d4bb4"]]),R={__name:"contextMenu",props:{data:{type:Object,required:!0}},emits:["choice"],setup(e,{emit:s}){const n=e;let u=document.querySelector("body>#contextBox");function r(e){y.value=!1,s("choice",e)}u||(u=document.createElement("div"),u.id="contextBox",document.body.appendChild(u));let h=t(),m=t(0),v=t(0),y=t(!1),x=t();return a((()=>{x.value.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation(),m.value=e.pageX,v.value=e.pageY,y.value=!0})),window.addEventListener("click",(e=>{u.contains(e.target)||(y.value=!1)}),!0),window.addEventListener("contextmenu",(e=>{x.value.contains(e.target)||(y.value=!1)}),!0)})),(e,t)=>(o(),l(p,null,[c("div",{ref_key:"mainEle",ref:x},[b(e.$slots,"default")],512),(o(),f(g,{to:d(u)},[i(D,{onChoice:r,ref_key:"nowMenu",ref:h,show:d(y),data:d(n).data,x:d(m),y:d(v)},null,8,["show","data","x","y"])],8,["to"]))],64))}},A={key:0,class:"message"},F={class:"info"},P={key:1,class:"recalled"},Y=e({__name:"history",props:{data:{type:Object,default:{},required:!0},right:{type:Boolean,default:!1,required:!1}},setup(e){const t=e;let a=k((()=>t.data.user===t.data.message?`${t.data.user} 撤回了一条消息`:`${t.data.user} 撤回了一条 ${t.data.message} 消息`));return(s,n)=>(o(),l("div",{class:w(["message-box",{right:d(t).right&&0===d(t).data.statue,normal:!(d(t).right&&0===d(t).data.statue)}])},[0===e.data.statue?(o(),l("div",A,[c("p",F,h(d(t).right?`${e.data.time}`:`${e.data.time} · ${e.data.user}`),1),i(R,{data:{title:"消息",menu:[{title:"撤回消息",event:"recall"},{title:"删除消息",event:"delete"},{title:"复制",sub:{title:!1,menu:[{title:"纯文本",event:"copy-text"},{title:"MarkDown",event:"copy-markdown"},{title:"HTML",event:"copy-html"}]}},{title:"管理员",sub:{title:!1,menu:[{title:"撤回消息",event:"admin-recall"},{title:"删除消息",event:"admin-delete"}]}}]}},{default:u((()=>[i(M,{class:"content",content:e.data.message,"header-level-start":2},null,8,["content"])])),_:1})])):(o(),l("p",P,h(d(a)),1))],2))}},[["__scopeId","data-v-dc095a4c"]]);class K extends _{constructor(e,t,a,s,n){super({}),this.id=e,this.user=t,this.statue=a,this.message=s,this.time=n}}let U=_([]),X=t(2);const z=20;let G,Q,V=!1,Z=t(0);function ee(){1===X.value&&S("没有更多啦"),X.value=2,G.send(JSON.stringify({check:localStorage.getItem("check"),type:"history",from:U.length,to:U.length+z}))}function te(e){let t=JSON.parse(e.data);if("history"===t.type){if(0==t.data.length)return void(X.value=1);X.value=0;for(let e=0;e<t.data.length;e++)U.unshift(new K(t.data[e].id,t.data[e].user,t.data[e].statue,t.data[e].message,t.data[e].time));U.length===t.data.length&&Q&&setTimeout(Q)}if("message"===t.type&&(U.push(new K(t.id,t.user,t.statue,t.message,t.time)),Z.value++),"recall"===t.type)for(let a=0;a<U.length;a++)if(U[a].id==t.id)return U[a].statue=1,void(U[a].message=t.user);"ERROR"===t.type&&location.reload()}const ae={class:"main"},se={class:"history-list"},ne={class:"input-box"},oe=(e=>(j("data-v-d6d24e2a"),e=e(),L(),e))((()=>c("span",{class:"demo-icon"},"",-1)));O(e({__name:"App",setup(e){a((()=>{V||(G=new WebSocket("wss://kuankuan.site/chat/ws"),G.onmessage=te,G.onopen=ee,V=!0),s((()=>{Z.value,m.value.scrollHeight-m.value.clientHeight-m.value.scrollTop<300&&setTimeout(g,0)}))}));let r=k((()=>n.height/4)),m=t();function g(){m.value.scrollTop=m.value.scrollHeight,Z.value=0}Q=()=>{m.value.scrollTop=m.value.scrollHeight};let b=q("username",t,sessionStorage,"",!1),_=B("",100),j=k((()=>0===X.value?"加载更多":1===X.value?"没有更多啦":2===X.value?"加载中":"出错啦"));function L(e){var t;"send"===e&&(_.refresh&&_.refresh(),t=_.value,/^\s*$/.test(t)?S("消息为空哦"):G.send(JSON.stringify({check:localStorage.getItem("check"),message:t,type:"send"})),_.value="")}return(e,t)=>(o(),l(p,null,[i($,{title:"聊天室",toLogin:!0}),c("div",ae,[c("div",{class:"history-box",ref_key:"historyBox",ref:m},[c("div",se,[c("button",{class:w(["get-more",{disabled:0!=d(X)}]),onClick:t[0]||(t[0]=(...e)=>d(ee)&&d(ee)(...e))},[c("span",null,h(d(j)),1)],2),(o(!0),l(p,null,v(d(U),(e=>(o(),f(Y,{data:e,key:e.id,right:e.user===d(b)},null,8,["data","right"])))),128))])],512),c("div",ne,[i(x,{name:"to-botton"},{default:u((()=>[C(c("button",{onClick:g,class:"to-bottom"},[c("span",null,[y(h(d(Z))+" ",1),oe])],512),[[T,d(Z)>0]])])),_:1}),i(N,{"other-buttons":[{event:"send",inner:'发送<span class="demo-icon"><span>'}],headerLevelStart:2,"max-editor-height":d(r),content:d(_),"onUpdate:content":t[1]||(t[1]=e=>E(_)?_.value=e.target.value:_=e.target.value),onCustomButtomClick:L},null,8,["other-buttons","max-editor-height","content"])])])],64))}},[["__scopeId","data-v-d6d24e2a"]])).mount("#app");
