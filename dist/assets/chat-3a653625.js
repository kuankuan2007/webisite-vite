import{_ as e,a as t,I as a,J as s,a0 as n,o,b as l,d as i,w as r,a1 as u,u as d,e as c,t as m,v as h,F as p,N as v,h as g,q as y,a2 as f,T as x,Y as b,O as k,M as w,K as _,L as S,n as q,a3 as B,s as C,r as E,a4 as O,j as T,p as j,f as L,i as N}from"./all-3e823b9f.js";import{m as $}from"./header-b76a1fc8.js";import{_ as H}from"./markdownShower-98ca1d23.js";import{m as I}from"./markDownEditor-8ac39544.js";const M={class:"menu"},J={key:0,class:"title"},R={class:"choice-list"},W=["onClick"],D=e({__name:"menu",props:{data:{type:Object,required:!0},x:{type:Number,required:!0},y:{type:Number,required:!0},show:{type:Boolean,required:!0},parentWidth:{type:Number,default:0,required:!1}},emits:["choice"],setup(e,{expose:b,emit:k}){const w=e;let _=t();a((()=>{s((()=>{w.x,w.y,L()}))}));let S=t(0),q=t(0),B=t(0),C=document.querySelector("body>#contextBox");function E(e){k("choice",e)}C||(C=document.createElement("div"),C.id="contextBox",document.body.appendChild(C));let O=0,T=0;function j(e){e.style.height=0}function L(){n.height-w.y<O+10?B.value=n.height-O-10-w.y:B.value=0,n.width-w.x<T+10?q.value=-T-w.parentWidth:q.value=0}function N(e){e.style.height="auto",O=e.clientHeight,T=e.clientWidth,L(),e.style.height="0",requestAnimationFrame((()=>{e.style.height=O+"px"}))}function $(e){e.style.top=w.y+O+"px",e.style.height=0}let H=t(),I=t(),A=t(void 0);return s((()=>{w.show||(A.value=void 0)})),b({menuBox:I}),(t,a)=>(o(),l("div",{class:"menu-box",ref_key:"menuBox",ref:I},[i(x,{duration:300,onBeforeEnter:j,onLeave:$,onEnter:N},{default:r((()=>[e.show?(o(),l("div",{key:0,class:"menu-fixd",ref_key:"menuEle",ref:H,style:u({"--x":d(w).x+d(q)+"px","--y":d(w).y+d(B)+"px"})},[c("div",M,[d(w).data.title?(o(),l("p",J,m(d(w).data.title),1)):h("",!0),c("ul",R,[(o(!0),l(p,null,v(e.data.menu,((e,t)=>(o(),l("li",{class:"choice",onClick:a=>function(e,t,a){e.sub?(A.value=t,S=a.target.offsetTop):e.event&&E(e.event)}(e,t,a),key:t},[g(m(e.title)+" ",1),(o(),y(f,{ref_for:!0,ref_key:"nowSubMenuTP",ref:_,to:d(C)},[e.sub?(o(),y(D,{key:0,ref_for:!0,ref:"nowSubMenu",show:d(A)===t,y:d(w).y+d(B)+d(S),x:d(w).x+d(q)+d(T),onChoice:a[0]||(a[0]=e=>E(e)),data:e.sub,"parent-width":d(T)},null,8,["show","y","x","data","parent-width"])):h("",!0)],8,["to"]))],8,W)))),128))])])],4)):h("",!0)])),_:1})],512))}},[["__scopeId","data-v-a05d4bb4"]]),A={__name:"contextMenu",props:{data:{type:Object,required:!0}},emits:["choice"],setup(e,{emit:s}){const n=e;let r=document.querySelector("body>#contextBox");function u(e){g.value=!1,s("choice",e)}r||(r=document.createElement("div"),r.id="contextBox",document.body.appendChild(r));let m=t(),h=t(0),v=t(0),g=t(!1),x=t();return a((()=>{x.value.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation(),h.value=e.pageX,v.value=e.pageY,g.value=!0})),window.addEventListener("click",(e=>{r.contains(e.target)||(g.value=!1)}),!0),window.addEventListener("contextmenu",(e=>{x.value.contains(e.target)||(g.value=!1)}),!0)})),(e,t)=>(o(),l(p,null,[c("div",{ref_key:"mainEle",ref:x},[b(e.$slots,"default")],512),(o(),y(f,{to:d(r)},[i(D,{onChoice:u,ref_key:"nowMenu",ref:m,show:d(g),data:d(n).data,x:d(h),y:d(v)},null,8,["show","data","x","y"])],8,["to"]))],64))}},F={key:0,class:"message"},P={class:"info"},Y={key:1,class:"recalled"},K=e({__name:"history",props:{data:{type:Object,default:{},required:!0},right:{type:Boolean,default:!1,required:!1}},emits:["recall"],setup(e,{emit:a}){const s=e;let n=t(!0),u=t();function h(e){"copy-markdown"===e?(B(s.data.message),C("复制成功")):"copy-html"===e?(B(u.value.makeHtml(s.data.message)),C("复制成功")):"delete"===e?n.value=!1:"recall"===e&&a("recall")}let p=k("username",t,sessionStorage,"",!1),v=k("userrights",t,sessionStorage,"",!1),g=w((()=>{let e={title:"消息",menu:[{title:"复制",sub:{title:!1,menu:[{title:"MarkDown",event:"copy-markdown"},{title:"HTML",event:"copy-html"}]}},{title:"删除消息",event:"delete"}]};return p.value===s.data.user&&(e.menu=e.menu.concat([{title:"撤回消息",event:"recall"}])),"1"===v.value&&(e.menu=e.menu.concat([{title:"管理员",sub:{title:!1,menu:[{title:"撤回消息",event:"recall"}]}}])),e})),y=w((()=>s.data.user===s.data.message?`${s.data.user} 撤回了一条消息`:`${s.data.message} 撤回了一条 ${s.data.user} 的消息`));return(t,a)=>_((o(),l("div",{class:q(["message-box",{right:d(s).right&&0===d(s).data.statue,normal:!(d(s).right&&0===d(s).data.statue)}])},[0===e.data.statue?(o(),l("div",F,[c("p",P,m(d(s).right?`${e.data.time}`:`${e.data.time} · ${e.data.user}`),1),i(A,{onChoice:h,data:d(g)},{default:r((()=>[i(H,{class:"content",content:e.data.message,ref_key:"messageShower",ref:u,"header-level-start":2},null,8,["content"])])),_:1},8,["data"])])):(o(),l("p",Y,m(d(y)),1))],2)),[[S,d(n)]])}},[["__scopeId","data-v-fdbabbe9"]]);class U extends E{constructor(e,t,a,s,n){super({}),this.id=e,this.user=t,this.statue=a,this.message=s,this.time=n}}let X=E([]),z=t(2);const G=20;let Q,V,Z=!1,ee=t(0);function te(){1===z.value&&C("没有更多啦"),z.value=2,Q.send(JSON.stringify({check:localStorage.getItem("check"),type:"history",from:X.length,to:X.length+G}))}function ae(e){Q.send(JSON.stringify({type:"recall",id:e,check:localStorage.getItem("check")}))}function se(e){let t=JSON.parse(e.data);if("history"===t.type){if(0==t.data.length)return void(z.value=1);z.value=0;for(let e=0;e<t.data.length;e++)X.unshift(new U(t.data[e].id,t.data[e].user,t.data[e].statue,t.data[e].message,t.data[e].time));X.length===t.data.length&&V&&setTimeout(V)}if("message"===t.type&&(X.push(new U(t.id,t.user,t.statue,t.message,t.time)),ee.value++),"recall"===t.type)for(let a=0;a<X.length;a++)if(X[a].id==t.id)return X[a].statue=1,void(X[a].message=t.user);"ERROR"===t.type&&location.reload()}const ne={class:"main"},oe={class:"history-list"},le={class:"input-box"},ie=(e=>(j("data-v-0c424a74"),e=e(),L(),e))((()=>c("span",{class:"demo-icon"},"",-1)));N(e({__name:"App",setup(e){a((()=>{Z||(Q=new WebSocket("wss://kuankuan.site/chat/ws"),Q.onmessage=se,Q.onopen=te,Z=!0),s((()=>{ee.value,h.value.scrollHeight-h.value.clientHeight-h.value.scrollTop<300&&setTimeout(f,0)}))}));let u=w((()=>n.height/4)),h=t();function f(){h.value.scrollTop=h.value.scrollHeight,ee.value=0}V=()=>{h.value.scrollTop=h.value.scrollHeight};let b=k("username",t,sessionStorage,"",!1),B=O("",100),E=w((()=>0===z.value?"加载更多":1===z.value?"没有更多啦":2===z.value?"加载中":"出错啦"));function j(e){var t;"send"===e&&(B.refresh&&B.refresh(),t=B.value,/^\s*$/.test(t)?C("消息为空哦"):Q.send(JSON.stringify({check:localStorage.getItem("check"),message:t,type:"send"})),B.value="")}return(e,t)=>(o(),l(p,null,[i($,{title:"聊天室","need-rights":!0,toLogin:!0}),c("div",ne,[c("div",{class:"history-box",ref_key:"historyBox",ref:h},[c("div",oe,[c("button",{class:q(["get-more",{disabled:0!=d(z)}]),onClick:t[0]||(t[0]=(...e)=>d(te)&&d(te)(...e))},[c("span",null,m(d(E)),1)],2),(o(!0),l(p,null,v(d(X),(e=>(o(),y(K,{onRecall:t=>d(ae)(e.id),data:e,key:e.id,right:e.user===d(b)},null,8,["onRecall","data","right"])))),128))])],512),c("div",le,[i(x,{name:"to-botton"},{default:r((()=>[_(c("button",{onClick:f,class:"to-bottom"},[c("span",null,[g(m(d(ee))+" ",1),ie])],512),[[S,d(ee)>0]])])),_:1}),i(I,{"other-buttons":[{event:"send",inner:'发送<span class="demo-icon"><span>'}],headerLevelStart:2,"max-editor-height":d(u),content:d(B),"onUpdate:content":t[1]||(t[1]=e=>T(B)?B.value=e.target.value:B=e.target.value),onCustomButtomClick:j},null,8,["other-buttons","max-editor-height","content"])])])],64))}},[["__scopeId","data-v-0c424a74"]])).mount("#app");
